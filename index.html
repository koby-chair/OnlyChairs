<script type="module">
  // ---------------- FIREBASE ----------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD3toK1Vgx0C1w2wmTjHFzWz0jGM1-Ct8U",
    authDomain: "onlychairs-61f27.firebaseapp.com",
    projectId: "onlychairs-61f27",
    storageBucket: "onlychairs-61f27.appspot.com",
    messagingSenderId: "435258326186",
    appId: "1:435258326186:web:00f2c85a7ec6ab77e1c7ef"
  };

  let app, auth, db;
  let state = {
    user: null,
    subs: [],
    theme: localStorage.getItem("oc_theme") || "light"
  };

  // ---------------- INIT FIREBASE ----------------
  async function initFirebase() {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
      state.user = user;
      updateAuthButtons();
      if (user) {
        loadSubsFromCloud();
      }
    });
  }

  // ---------------- SUBS STORAGE ----------------
  function subsDocRef() {
    return doc(db, "subs", state.user.uid);
  }

  async function saveSubsToCloud() {
    try {
      if (!state.user) return;
      await setDoc(
        subsDocRef(),
        { subs: state.subs, updatedAt: new Date() },
        { merge: true }
      );
    } catch (err) {
      console.warn("Failed to save subs", err);
    }
  }

  async function loadSubsFromCloud() {
    try {
      if (!state.user) return;
      const snap = await getDoc(subsDocRef());
      if (snap.exists()) {
        state.subs = snap.data().subs || [];
      }
    } catch (err) {
      console.warn("Failed to load subs", err);
    }
  }

  // ---------------- RENDER ----------------
  function renderHero() {
    const hero = document.getElementById("hero");
    if (!hero) return;
    hero.innerHTML = `
      <h1>Welcome to OnlyChairs ðŸª‘</h1>
      <p>Premium chair content â€” subscribe now.</p>
    `;
  }

  function renderCreators() {
    const container = document.getElementById("creators");
    if (!container) return;
    container.innerHTML = `
      <h2>Top Chair Creators</h2>
      <ul>
        <li>ðŸª‘ WoodenChair</li>
        <li>ðŸª‘ GamerChairPro</li>
        <li>ðŸª‘ SofaSupreme</li>
      </ul>
    `;
  }

  function renderTrending() {
    const container = document.getElementById("trending");
    if (!container) return;
    container.innerHTML = `
      <h2>Trending Chairs</h2>
      <ul>
        <li>ðŸ”¥ Recliner Deluxe</li>
        <li>ðŸ”¥ Ergonomic Beast</li>
        <li>ðŸ”¥ Throne of Chairs</li>
      </ul>
    `;
  }

  // ---------------- THEME ----------------
  function applyTheme(mode) {
    document.documentElement.dataset.theme = mode;
    document.body.classList.toggle("light", mode === "light");
    localStorage.setItem("oc_theme", mode);
  }

  function attachUI() {
    const btn = document.getElementById("toggleTheme");
    if (!btn) return;
    btn.addEventListener("click", () => {
      state.theme = state.theme === "dark" ? "light" : "dark";
      applyTheme(state.theme);
      btn.setAttribute("aria-pressed", state.theme === "light");
    });

    document.getElementById("signupBtn")?.addEventListener("click", async () => {
      const email = prompt("Enter email:");
      const pass = prompt("Enter password:");
      if (email && pass) {
        await createUserWithEmailAndPassword(auth, email, pass);
      }
    });

    document.getElementById("loginBtn")?.addEventListener("click", async () => {
      const email = prompt("Enter email:");
      const pass = prompt("Enter password:");
      if (email && pass) {
        await signInWithEmailAndPassword(auth, email, pass);
      }
    });

    document.getElementById("logoutBtn")?.addEventListener("click", async () => {
      await signOut(auth);
    });
  }

  // ---------------- AUTH BUTTONS ----------------
  function updateAuthButtons() {
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    if (!loginBtn || !signupBtn || !logoutBtn) return;

    if (state.user) {
      loginBtn.style.display = "none";
      signupBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
    } else {
      loginBtn.style.display = "inline-block";
      signupBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
    }
  }

  // ---------------- ON LOAD ----------------
  document.addEventListener("DOMContentLoaded", async () => {
    await initFirebase();
    applyTheme(state.theme);
    renderHero();
    renderCreators();
    renderTrending();
    attachUI();
    updateAuthButtons();
  });
</script>
